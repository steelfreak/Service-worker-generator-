<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Service Worker Generator</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
  h1 { font-size: 24px; }
  button, input { font-size: 16px; padding: 10px 15px; margin-top: 15px; }
  textarea { width: 100%; height: 300px; margin-top: 15px; font-family: monospace; font-size: 14px; }
  label { font-weight: bold; display: block; margin-top: 20px; }
</style>
</head>
<body>
<h1>Service Worker Generator</h1>
<p>Select a folder with your project files to generate a service worker.</p>
<button id="pickFolderBtn">Pick Folder</button>

<label for="excludeInput">Exclude files/folders (comma-separated):</label>
<input type="text" id="excludeInput" placeholder="e.g. node_modules,secret.txt,images/temp" />

<pre id="fileList"></pre>
<textarea id="swCode" readonly placeholder="Service Worker code will appear here..."></textarea>

<button id="downloadSWBtn" style="display:none;">Download sw.js</button>

<script>
  const pickFolderBtn = document.getElementById('pickFolderBtn');
  const fileListEl = document.getElementById('fileList');
  const swCodeEl = document.getElementById('swCode');
  const excludeInput = document.getElementById('excludeInput');
  const downloadSWBtn = document.getElementById('downloadSWBtn');

  let currentSWCode = '';

  pickFolderBtn.addEventListener('click', async () => {
    try {
      const excludeRaw = excludeInput.value.trim();
      const excludes = excludeRaw ? excludeRaw.split(',').map(e => e.trim()).filter(e => e.length > 0) : [];

      const dirHandle = await window.showDirectoryPicker();
      fileListEl.textContent = 'Scanning files...';
      swCodeEl.value = '';
      downloadSWBtn.style.display = 'none';
      currentSWCode = '';

      const files = [];

      async function traverseDir(handle, path='') {
        for await (const entry of handle.values()) {
          if(entry.kind === 'file') {
            const filePath = path + '/' + entry.name;
            if (!excludes.some(ex => filePath.includes(ex))) {
              files.push(filePath);
            }
          } else if(entry.kind === 'directory') {
            const dirPath = path + '/' + entry.name;
            if (!excludes.some(ex => dirPath.includes(ex))) {
              await traverseDir(entry, dirPath);
            }
          }
        }
      }

      await traverseDir(dirHandle, '');

      fileListEl.textContent = files.join('\n');

      // Generate service worker code
      const cacheName = 'my-site-cache-v1';
      const cacheFiles = files.map(f => `'${f.slice(1)}'`).join(',\n  ');

      const swCode = `
self.addEventListener('install', event => {
  event.waitUntil(
    caches.open('${cacheName}').then(cache => {
      return cache.addAll([
  ${cacheFiles}
      ]);
    })
  );
});

self.addEventListener('fetch', event => {
  event.respondWith(
    caches.match(event.request).then(response => {
      return response || fetch(event.request);
    })
  );
});
`;

      swCodeEl.value = swCode;
      currentSWCode = swCode;
      downloadSWBtn.style.display = 'inline-block';
    } catch (error) {
      fileListEl.textContent = 'Error: ' + error.message;
      swCodeEl.value = '';
      downloadSWBtn.style.display = 'none';
      currentSWCode = '';
    }
  });

  downloadSWBtn.addEventListener('click', () => {
    if (!currentSWCode) return;
    const blob = new Blob([currentSWCode], { type: 'application/javascript' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'sw.js';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });
</script>
</body>
</html>
